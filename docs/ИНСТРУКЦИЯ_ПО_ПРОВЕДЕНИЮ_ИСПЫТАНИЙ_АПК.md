# ИНСТРУКЦИЯ ПО ПРОВЕДЕНИЮ ИСПЫТАНИЙ АПК
## Автоматизированная Политика Контроля

---

## 1. ОБЩИЕ ПОЛОЖЕНИЯ

### 1.1 Назначение документа
Настоящая инструкция определяет порядок подготовки, проведения и документирования испытаний системы АПК.

### 1.2 Область применения
Инструкция применяется для проведения приемочных испытаний системы АПК в тестовой и производственной средах.

### 1.3 Нормативные ссылки
- Программа и методика испытаний АПК
- Тестовые сценарии АПК
- Протокол испытаний АПК

---

## 2. ПОДГОТОВКА К ИСПЫТАНИЯМ

### 2.1 Требования к тестовой среде

#### 2.1.1 Аппаратные требования
- **FortiGate кластер:** 2 устройства с поддержкой HA
- **Kubernetes кластер:** минимум 3 узла
- **Сетевое оборудование:** коммутаторы с резервированием
- **Серверы:** для RADIUS, LDAP, Zabbix, StarRocks, Superset
- **Рабочие станции:** для проведения тестирования

#### 2.1.2 Программные требования
- **FortiOS:** версия 7.0 или выше
- **Kubernetes:** версия 1.24 или выше
- **Cilium:** версия 1.12 или выше
- **RADIUS сервер:** FreeRADIUS 3.0 или выше
- **LDAP сервер:** OpenLDAP 2.4 или выше
- **Zabbix:** версия 6.0 или выше
- **StarRocks:** версия 2.5 или выше
- **Superset:** версия 2.0 или выше

#### 2.1.3 Сетевые требования
- **Внешняя сеть:** доступ к интернету для обновлений
- **Внутренняя сеть:** изолированная тестовая сеть
- **NTP серверы:** доступ к серверам времени
- **DNS серверы:** разрешение имен

### 2.2 Подготовка тестовых данных

#### 2.2.1 Тестовые пользователи
```bash
# Создание тестовых пользователей в RADIUS
# Файл: /etc/freeradius/3.0/users

# Пользователь с групповой политикой №1
testuser1 Cleartext-Password := "password1"
    Reply-Message := "Group Policy 1",
    Fortinet-Group-Name := "group1"

# Пользователь с групповой политикой №2
testuser2 Cleartext-Password := "password2"
    Reply-Message := "Group Policy 2",
    Fortinet-Group-Name := "group2"

# Пользователь с групповой политикой №3-9
testuser3 Cleartext-Password := "password3"
    Reply-Message := "Group Policy 3",
    Fortinet-Group-Name := "group3"
```

#### 2.2.2 Тестовые политики FortiGate
```bash
# Создание тестовых политик в FortiGate
# Групповая политика №1
config user group
    edit "group1"
        set member "testuser1"
    next
end

# Групповая политика №2
config user group
    edit "group2"
        set member "testuser2"
    next
end

# Индивидуальная политика для пользователя
config firewall policy
    edit 1
        set name "Individual Policy Test"
        set srcintf "port1"
        set dstintf "port2"
        set srcaddr "all"
        set dstaddr "all"
        set action accept
        set schedule "always"
        set service "ALL"
        set groups "group2"
    next
end
```

#### 2.2.3 Тестовые угрозы
```bash
# Создание тестовых файлов для проверки AV
# Вирус-тест (EICAR)
echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > /tmp/eicar.txt

# Создание тестовых атак для IPS
# SQL Injection тест
curl "http://test-target.com/search?q=1' OR '1'='1"

# XSS тест
curl "http://test-target.com/search?q=<script>alert('XSS')</script>"
```

### 2.3 Настройка инструментов тестирования

#### 2.3.1 Установка зависимостей
```bash
# Установка Python зависимостей
pip install -r tests/requirements.txt

# Установка kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
sudo mv kubectl /usr/local/bin/

# Установка cilium CLI
curl -L --remote-name-all https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz
tar xzvf cilium-linux-amd64.tar.gz
sudo mv cilium /usr/local/bin/
```

#### 2.3.2 Настройка переменных окружения
```bash
# Создание файла .env
cat > tests/.env << EOF
# FortiGate настройки
FORTIGATE_HOST=192.168.1.1
FORTIGATE_USER=admin
FORTIGATE_PASSWORD=admin

# Kubernetes настройки
KUBECONFIG=/path/to/kubeconfig

# RADIUS настройки
RADIUS_HOST=192.168.1.10
RADIUS_PORT=1812
RADIUS_SECRET=testing123

# LDAP настройки
LDAP_HOST=192.168.1.11
LDAP_PORT=389
LDAP_BASE_DN=dc=test,dc=local
LDAP_USER=cn=admin,dc=test,dc=local
LDAP_PASSWORD=admin

# Zabbix настройки
ZABBIX_HOST=192.168.1.12
ZABBIX_PORT=10051
ZABBIX_USER=admin
ZABBIX_PASSWORD=zabbix

# StarRocks настройки
STARROCKS_HOST=192.168.1.13
STARROCKS_PORT=9030
STARROCKS_USER=root
STARROCKS_PASSWORD=starrocks

# Superset настройки
SUPERSET_HOST=192.168.1.14
SUPERSET_PORT=8088
SUPERSET_USER=admin
SUPERSET_PASSWORD=superset
EOF
```

---

## 3. ПОРЯДОК ПРОВЕДЕНИЯ ИСПЫТАНИЙ

### 3.1 Предварительная проверка

#### 3.1.1 Проверка готовности системы
```bash
# Запуск предварительной проверки
cd tests
python run_tests.py --check-environment

# Проверка доступности всех сервисов
python -m pytest test_network_connectivity.py -v
```

#### 3.1.2 Проверка конфигурации
```bash
# Проверка конфигурации FortiGate
ssh admin@192.168.1.1
execute ha status
execute ntp status
execute update status

# Проверка состояния Kubernetes
kubectl get nodes
kubectl get pods --all-namespaces
kubectl cluster-info
```

### 3.2 Выполнение внешних тестов

#### 3.2.1 Тестирование FortiGate
```bash
# Запуск тестов FortiGate
python -m pytest test_fortigate.py -v --tb=short

# Проверка конкретных функций
python -m pytest test_fortigate.py::TestFortiGate::test_ntp_sync -v
python -m pytest test_fortigate.py::TestFortiGate::test_ha_cluster -v
python -m pytest test_fortigate.py::TestFortiGate::test_radius_accounting -v
```

#### 3.2.2 Тестирование фильтрации трафика
```bash
# Запуск тестов фильтрации
python -m pytest test_traffic_filtering.py -v

# Тестирование групповых политик
python -m pytest test_traffic_filtering.py::TestGroupPolicies -v

# Тестирование индивидуальных политик
python -m pytest test_traffic_filtering.py::TestIndividualPolicies -v
```

#### 3.2.3 Тестирование сервисов безопасности
```bash
# Запуск тестов безопасности
python -m pytest test_security_services.py -v

# Тестирование антивируса
python -m pytest test_security_services.py::TestAntivirus -v

# Тестирование IPS
python -m pytest test_security_services.py::TestIPS -v
```

### 3.3 Выполнение внутренних тестов

#### 3.3.1 Тестирование Kubernetes
```bash
# Запуск тестов Kubernetes
python -m pytest test_kubernetes.py -v

# Проверка состояния кластера
kubectl get nodes -o wide
kubectl describe nodes

# Проверка сетевых компонентов
cilium status
kubectl get networkpolicies --all-namespaces
```

#### 3.3.2 Тестирование сервисов АПК
```bash
# Запуск тестов сервисов
python -m pytest test_apk_services.py -v

# Тестирование MHE RADIUS
python -m pytest test_apk_services.py::TestMHERADIUS -v

# Тестирование MHE Log
python -m pytest test_apk_services.py::TestMHELog -v
```

### 3.4 Тестирование отказоустойчивости

#### 3.4.1 Тестирование отказоустойчивости FortiGate
```bash
# Запуск тестов отказоустойчивости
python -m pytest test_failover.py::TestFortiGateFailover -v

# Ручное тестирование
# 1. Определить активное устройство
ssh admin@192.168.1.1
execute ha status

# 2. Отключить активное устройство
# 3. Проверить переключение
# 4. Включить устройство обратно
# 5. Проверить восстановление
```

#### 3.4.2 Тестирование отказоустойчивости Kubernetes
```bash
# Запуск тестов отказоустойчивости K8s
python -m pytest test_failover.py::TestKubernetesFailover -v

# Ручное тестирование
# 1. Определить узел кластера
kubectl get nodes

# 2. Отключить узел
# 3. Проверить переключение подов
kubectl get pods --all-namespaces -o wide

# 4. Включить узел обратно
# 5. Проверить восстановление
```

---

## 4. ДОКУМЕНТИРОВАНИЕ РЕЗУЛЬТАТОВ

### 4.1 Заполнение протокола испытаний

#### 4.1.1 Структура протокола
1. **Общие сведения:** дата, место, время проведения
2. **Состав комиссии:** ФИО, должности, подписи
3. **Результаты тестов:** по каждому тесту отдельно
4. **Сводка результатов:** общая статистика
5. **Выявленные проблемы:** описание и рекомендации
6. **Заключение комиссии:** общая оценка

#### 4.1.2 Заполнение результатов
```bash
# Генерация отчета о результатах
python generate_test_report.py --output protocol_results.json

# Конвертация в формат протокола
python convert_to_protocol.py --input protocol_results.json --output protocol.md
```

### 4.2 Создание отчетов

#### 4.2.1 Автоматический отчет
```bash
# Генерация HTML отчета
python -m pytest --html=report.html --self-contained-html

# Генерация JSON отчета
python -m pytest --json-report --json-report-file=report.json
```

#### 4.2.2 Ручной отчет
```bash
# Создание отчета вручную
cat > test_report.md << EOF
# ОТЧЕТ О РЕЗУЛЬТАТАХ ИСПЫТАНИЙ АПК

## Общие сведения
- Дата проведения: $(date)
- Количество тестов: $(grep -c "def test_" tests/*.py)
- Успешно: $(grep -c "PASSED" report.html)
- Неуспешно: $(grep -c "FAILED" report.html)

## Детальные результаты
$(cat protocol_results.json | jq '.')

## Заключение
$(cat conclusion.txt)
EOF
```

---

## 5. УСТРАНЕНИЕ ПРОБЛЕМ

### 5.1 Типичные проблемы и решения

#### 5.1.1 Проблемы с FortiGate
```bash
# Проблема: NTP не синхронизируется
# Решение:
ssh admin@192.168.1.1
config system ntp
    set ntpsync enable
    set server-mode disable
    config ntpserver
        edit 1
            set server "pool.ntp.org"
        next
    end
end
execute ntp update

# Проблема: HA кластер не синхронизируется
# Решение:
execute ha sync
execute ha status
```

#### 5.1.2 Проблемы с Kubernetes
```bash
# Проблема: Поды не запускаются
# Решение:
kubectl describe pod <pod-name> -n <namespace>
kubectl logs <pod-name> -n <namespace>
kubectl get events --sort-by=.metadata.creationTimestamp

# Проблема: Cilium не работает
# Решение:
cilium status
cilium connectivity test
kubectl get pods -n kube-system | grep cilium
```

#### 5.1.3 Проблемы с сервисами
```bash
# Проблема: RADIUS не отвечает
# Решение:
systemctl status freeradius
journalctl -u freeradius -f
radtest testuser password localhost 1812 testing123

# Проблема: LDAP недоступен
# Решение:
systemctl status slapd
ldapsearch -H ldap://192.168.1.11 -D "cn=admin,dc=test,dc=local" -w admin -b "dc=test,dc=local"
```

### 5.2 Логирование и отладка

#### 5.2.1 Включение подробного логирования
```bash
# Настройка логирования для тестов
export PYTEST_LOG_LEVEL=DEBUG
export PYTEST_LOG_FORMAT=%(asctime)s [%(levelname)8s] %(name)s: %(message)s

# Запуск тестов с подробным логированием
python -m pytest -v -s --log-cli-level=DEBUG
```

#### 5.2.2 Сбор логов системы
```bash
# Сбор логов FortiGate
ssh admin@192.168.1.1
execute log filter category 0
execute log display

# Сбор логов Kubernetes
kubectl logs --all-containers=true --all-namespaces > k8s_logs.txt

# Сбор логов сервисов
journalctl -u freeradius > radius_logs.txt
journalctl -u slapd > ldap_logs.txt
```

---

## 6. ЗАВЕРШЕНИЕ ИСПЫТАНИЙ

### 6.1 Финальная проверка

#### 6.1.1 Проверка всех компонентов
```bash
# Финальная проверка системы
python -m pytest test_integration.py::TestAPKEndToEnd::test_full_apk_flow -v

# Проверка производительности
python -m pytest test_performance.py -v
```

#### 6.1.2 Очистка тестовых данных
```bash
# Удаление тестовых пользователей
# Удаление тестовых политик
# Очистка логов
# Восстановление исходной конфигурации
```

### 6.2 Подготовка итогового отчета

#### 6.2.1 Сбор всех результатов
```bash
# Создание итогового отчета
python create_final_report.py \
    --protocol protocol_results.json \
    --test-results report.json \
    --logs logs/ \
    --output final_report.md
```

#### 6.2.2 Утверждение результатов
```bash
# Создание архива с результатами
tar -czf apk_test_results_$(date +%Y%m%d_%H%M%S).tar.gz \
    protocol_results.json \
    report.html \
    report.json \
    logs/ \
    final_report.md
```

---

## 7. КОНТРОЛЬНЫЕ ТОЧКИ

### 7.1 Чек-лист подготовки
- [ ] Тестовая среда развернута
- [ ] Все сервисы запущены и доступны
- [ ] Тестовые данные подготовлены
- [ ] Инструменты тестирования установлены
- [ ] Переменные окружения настроены
- [ ] Комиссия сформирована
- [ ] Документация подготовлена

### 7.2 Чек-лист проведения
- [ ] Предварительная проверка выполнена
- [ ] Внешние тесты проведены
- [ ] Внутренние тесты проведены
- [ ] Тесты отказоустойчивости проведены
- [ ] Все результаты зафиксированы
- [ ] Проблемы выявлены и документированы
- [ ] Протокол заполнен

### 7.3 Чек-лист завершения
- [ ] Все тесты завершены
- [ ] Результаты проанализированы
- [ ] Отчет подготовлен
- [ ] Протокол подписан
- [ ] Тестовые данные очищены
- [ ] Система восстановлена
- [ ] Документация передана

---

## 8. ПРИЛОЖЕНИЯ

### 8.1 Скрипты автоматизации

#### 8.1.1 Скрипт полного тестирования
```bash
#!/bin/bash
# full_test.sh - Полное тестирование АПК

set -e

echo "Начало полного тестирования АПК"
echo "Дата: $(date)"

# Проверка окружения
echo "Проверка окружения..."
python run_tests.py --check-environment

# Внешние тесты
echo "Выполнение внешних тестов..."
python -m pytest test_network_connectivity.py -v
python -m pytest test_fortigate.py -v
python -m pytest test_traffic_filtering.py -v
python -m pytest test_security_services.py -v

# Внутренние тесты
echo "Выполнение внутренних тестов..."
python -m pytest test_kubernetes.py -v
python -m pytest test_apk_services.py -v

# Тесты отказоустойчивости
echo "Выполнение тестов отказоустойчивости..."
python -m pytest test_failover.py -v

# Интеграционные тесты
echo "Выполнение интеграционных тестов..."
python -m pytest test_integration.py -v

# Генерация отчета
echo "Генерация отчета..."
python -m pytest --html=report.html --self-contained-html
python generate_test_report.py --output protocol_results.json

echo "Тестирование завершено"
echo "Результаты сохранены в report.html и protocol_results.json"
```

#### 8.1.2 Скрипт проверки готовности
```bash
#!/bin/bash
# check_readiness.sh - Проверка готовности к тестированию

echo "Проверка готовности системы к тестированию"

# Проверка FortiGate
echo "Проверка FortiGate..."
ssh admin@192.168.1.1 "execute ha status" || echo "ОШИБКА: FortiGate недоступен"

# Проверка Kubernetes
echo "Проверка Kubernetes..."
kubectl get nodes || echo "ОШИБКА: Kubernetes недоступен"

# Проверка сервисов
echo "Проверка сервисов..."
systemctl is-active freeradius || echo "ОШИБКА: RADIUS не активен"
systemctl is-active slapd || echo "ОШИБКА: LDAP не активен"

# Проверка сетевой связности
echo "Проверка сетевой связности..."
python -m pytest test_network_connectivity.py -v

echo "Проверка готовности завершена"
```

### 8.2 Шаблоны конфигураций

#### 8.2.1 Конфигурация FortiGate для тестирования
```bash
# fortigate_test_config.conf
config system global
    set hostname "FG-TEST"
    set timezone "Europe/Minsk"
end

config system ntp
    set ntpsync enable
    config ntpserver
        edit 1
            set server "pool.ntp.org"
        next
    end
end

config system ha
    set group-name "test-cluster"
    set group-id 1
    set password "test123"
    set hbdev "port3" 50
    set override disable
    set priority 200
    set monitor "port1" "port2"
end

config user group
    edit "test-group1"
        set member "testuser1"
    next
    edit "test-group2"
        set member "testuser2"
    next
end
```

#### 8.2.2 Конфигурация Kubernetes для тестирования
```yaml
# k8s_test_config.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: apk-test

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: apk-config
  namespace: apk-test
data:
  fortigate_host: "192.168.1.1"
  radius_host: "192.168.1.10"
  ldap_host: "192.168.1.11"
```

---

**Документ подготовлен:** [Дата]  
**Версия:** 1.0  
**Статус:** Утвержден